{% extends "base.html" %}

{% block title %}Dashboard - KissBot{% endblock %}

{% block content %}
<!-- outer Alpine mount moved to the inner content; data-scopes attribute now used -->
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-2xl font-bold">Dashboard</h1>
            <p class="text-gray-400">Bienvenue, {{ user.display_name }} üëã</p>
        </div>
        <div class="flex items-center space-x-2"> 
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm 
                         {{ 'bg-green-900 text-green-300' if bot_active else 'bg-red-900 text-red-300' }}">
                <span class="w-2 h-2 rounded-full mr-2 
                             {{ 'bg-green-400' if bot_active else 'bg-red-400' }}"></span>
                Bot {{ 'actif' if bot_active else 'inactif' }}
            </span>
        </div>
    </div>
<div id="dashboard-root" data-scopes='{{ scopes | tojson | safe if scopes else "[]" }}' data-channel='{{ user.login }}'>
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="bg-gray-800 rounded-lg p-4">
            <div class="text-gray-400 text-sm">Banwords actifs</div>
            <div class="text-2xl font-bold" id="banwords-count">0</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4">
            <div class="text-gray-400 text-sm">Messages trait√©s (24h)</div>
            <div class="text-2xl font-bold">--</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4">
            <div class="text-gray-400 text-sm">Bans automatiques</div>
            <div class="text-2xl font-bold">--</div>
        </div>
    </div>
    
    <!-- Banwords Section -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center">
            <span class="mr-2">üö´</span>
            Banwords
        </h2>
        
        <!-- Add form (managed by vanilla JS) -->
        <div class="flex space-x-2 mb-4">
            <input id="banword-input" type="text"
                   placeholder="Ajouter un mot √† bannir..."
                   class="flex-1 bg-gray-700 border border-gray-600 rounded px-4 py-2 focus:outline-none focus:border-twitch">
            <button id="banword-add" type="button"
                    class="bg-twitch hover:bg-twitch-dark px-4 py-2 rounded font-semibold transition-colors">
                Ajouter
            </button>
        </div>

        <!-- List (rendered by vanilla JS) -->
        <div id="banwords-list" class="space-y-2">
            <p id="banwords-empty" class="text-gray-500 text-center py-4" style="display:none;">Aucun banword configur√©. Ajoutez-en un ci-dessus.</p>
        </div>
    </div>
    
    <!-- Settings Section -->
    <div class="bg-gray-800 rounded-lg p-6 mt-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center">
            <span class="mr-2">‚öôÔ∏è</span>
            Param√®tres
        </h2>
        
        <!-- Scopes info -->
        <div class="mb-4">
            <div class="text-gray-400 text-sm mb-2">Permissions actuelles</div>
            <div class="flex flex-wrap gap-2">
                <div id="scopes-list" class="flex flex-wrap gap-2 w-full mb-2 text-sm text-gray-300">
                    {% if scopes %}
                        {% for s in scopes %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-gray-700 text-gray-300">{{ s }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-gray-500 text-sm">Aucune permission d√©tect√©e</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Update scopes button -->
        <div class="flex items-center justify-between">
            <div>
                <div class="text-white font-medium">Mettre √† jour les permissions</div>
                <div class="text-gray-400 text-sm">R√©-autorisez le bot pour obtenir les derni√®res permissions</div>
            </div>
            <a href="/auth/twitch?force=true" 
               class="bg-twitch hover:bg-twitch-dark px-4 py-2 rounded font-semibold transition-colors inline-flex items-center">
                <span class="mr-2">üîÑ</span>
                Update Scopes
            </a>
        </div>
    </div>
    
    <!-- Revoke Section -->
    <div class="mt-8 text-center">
        <a href="https://www.twitch.tv/settings/connections" 
           target="_blank"
           class="text-gray-500 hover:text-gray-400 text-sm">
            R√©voquer l'acc√®s du bot ‚Üí
        </a>
    </div>
    
</div>

<script>
// Vanilla JS frontend for banwords + scopes (no eval, CSP-safe)
document.addEventListener('DOMContentLoaded', function () {
    const root = document.getElementById('dashboard-root');
    const channel = root.dataset.channel;
    const scopesListEl = document.getElementById('scopes-list');

    // Banwords elements
    const banwordsList = document.getElementById('banwords-list');
    const banwordsEmpty = document.getElementById('banwords-empty');
    const input = document.getElementById('banword-input');
    const addBtn = document.getElementById('banword-add');

    async function loadBanwords() {
        try {
            const res = await fetch(`/api/banwords/${channel}`, { credentials: 'include' });
            if (!res.ok) return;
            const data = await res.json();
            renderBanwords(data.banwords || []);
        } catch (e) { console.error('Failed to load banwords', e); }
    }

    function renderBanwords(list) {
        banwordsList.querySelectorAll('.banword-row').forEach(n => n.remove());
        const countEl = document.getElementById('banwords-count');
        if (countEl) countEl.textContent = String(list.length || 0);
        if (!list || list.length === 0) {
            banwordsEmpty.style.display = '';
            return;
        }
        banwordsEmpty.style.display = 'none';
        list.forEach(word => {
            const row = document.createElement('div');
            row.className = 'banword-row flex items-center justify-between bg-gray-700 rounded px-4 py-2';
            const span = document.createElement('span');
            span.textContent = word;
            const btn = document.createElement('button');
            btn.className = 'text-red-400 hover:text-red-300 text-sm';
            btn.textContent = 'Supprimer';
            btn.addEventListener('click', async () => {
                try {
                    const r = await fetch(`/api/banwords/${channel}/${encodeURIComponent(word)}`, { method: 'DELETE', credentials: 'include' });
                    if (r.ok) {
                        // reload list
                        await loadBanwords();
                    }
                } catch (e) { console.error('Failed to remove banword', e); }
            });
            row.appendChild(span);
            row.appendChild(btn);
            banwordsList.appendChild(row);
        });
    }

    addBtn.addEventListener('click', async () => {
        const word = input.value.trim().toLowerCase();
        if (!word || word.length < 3) return alert('Mot trop court (min 3 caract√®res)');
        try {
            const r = await fetch(`/api/banwords/${channel}`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ word })
            });
            const body = await r.json().catch(()=>({detail:'Erreur r√©seau'}));
            if (r.ok) {
                alert(body?.message || '‚úÖ Banword ajout√©!');
                await loadBanwords();
                input.value = '';
            } else {
                // Affiche le d√©tail ou le message d'erreur
                const msg = body?.message || body?.detail || JSON.stringify(body) || 'Erreur inconnue';
                alert('‚ùå ' + msg);
            }
        } catch (e) { 
            console.error('Failed to add banword', e);
            alert('‚ùå Erreur r√©seau: ' + e.message);
        }
    });

    // Fetch scopes from protected endpoint to ensure freshest view
    async function loadScopes() {
        try {
            const res = await fetch('/api/me/scopes', { credentials: 'include' });
            if (!res.ok) return;
            const data = await res.json();
            // Replace scopes-list content
            scopesListEl.innerHTML = '';
            if (!data.scopes || data.scopes.length === 0) {
                scopesListEl.textContent = '';
                const span = document.createElement('span');
                span.className = 'text-gray-500 text-sm';
                span.textContent = 'Aucune permission d√©tect√©e';
                scopesListEl.appendChild(span);
                return;
            }
            data.scopes.forEach(s => {
                const span = document.createElement('span');
                span.className = 'inline-flex items-center px-2 py-1 rounded text-xs bg-gray-700 text-gray-300 mr-2 mb-2';
                span.textContent = s;
                scopesListEl.appendChild(span);
            });
        } catch (e) { console.error('Failed to load scopes', e); }
    }

    // Init
    loadBanwords();
    loadScopes();
});
</script>
{% endblock %}
